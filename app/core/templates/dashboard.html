{% extends "base.html" %}

{% block title %}Core Dashboard{% endblock %}

{% block extra_head %}
{#    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack/dist/gridstack.min.css">#}
{#    <script src="https://cdn.jsdelivr.net/npm/gridstack/dist/gridstack.all.min.js"></script>#}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.3.1/gridstack.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.3.1/gridstack-all.min.js"></script>
{% endblock extra_head %}

{% block content %}
    <!-- Input Section remains fixed -->
    <div id="input-section" class="glass-effect text-center mb-4">
        <p class="lead">Select your input method:</p>
        <button class="theme-btn me-4" onclick="setInput('PC')">PC</button>
        <button class="theme-btn" onclick="setInput('Controller')">Controller</button>
    </div>

    <!-- Grid-Stack for Draggable/Resizable Components -->
    <div class="grid-stack"></div>

    <!-- Screenshots Section -->
    <div class="row mt-4">
        <div class="theme-container col-12">
            <h3 class="text-left">Screenshots</h3>
            <div id="screenshot-row" class="theme-scroll-container">
                <!-- Images dynamically inserted -->
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_content %}
    <div id="end-game-bar" class="fixed-bottom theme-bar p-1">
        <button id="end-game-btn" class="theme-btn-danger">END GAME</button>
        <button id="reset-input-btn" class="theme-btn-secondary">Change Input Type</button>
        <div id="game-outcome-options" class="mt-3" style="display: none;">
            <p>Select Game Outcome:</p>
            <button class="theme-btn-success me-2" onclick="setGameOutcome('win')">Win</button>
            <button class="theme-btn-danger me-2" onclick="setGameOutcome('loss')">Loss</button>
            <button class="theme-btn-warning me-2" onclick="setGameOutcome('draw')">Draw</button>
            <button class="theme-btn-secondary" onclick="setGameOutcome('left')">Invalid</button>
        </div>
    </div>
{% endblock extra_content %}

{% block extra_scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let grid = GridStack.init({
            margin: 2,
            float: true, // Allows smoother dragging and resizing
            acceptWidgets: true // Enables adding widgets dynamically
        });

        {% for component in components %}
            grid.addWidget(
              `<div id="{{ component.id }}">
                 <div id="{{ component.config.parent }}" class="grid-stack-item-content">
                   {{ component.html | safe }}
                 </div>
               </div>`,
              {
                x: {{ component.config.x }},
                y: {{ component.config.y }},
                w: {{ component.config.width }},
                h: {{ component.config.height }},
              }
            );
        {% endfor %}

        // Listen for the 'change' event to save the layout
        grid.on('change', function(event, items){
            // send alert with that shows layout
            const layout = items.map(item => ({
                parent: item.el.children[0].id,
                id: item.el.id,
                x: item.x,
                y: item.y,
                width: item.w,
                height: item.h
            }));
            fetch('/save_layout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ layout })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Layout saved successfully!');
                } else {
                    console.error('Error saving layout:', data);
                }
            })
            .catch(error => console.error('Error saving layout:', error));
        });

    });

    </script>
    {% for component in components %}
    <script>{{ component.js | safe }}</script>
    {% endfor %}
{% endblock extra_scripts %}
